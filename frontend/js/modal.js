// ===== MODAL MODULE =====\nconst modalModule = {\n    // Estados del módulo\n    state: {\n        currentImage: null,\n        activeTab: 'original',\n        isOpen: false\n    },\n\n    // Referencias DOM\n    elements: {\n        modal: null,\n        modalClose: null,\n        title: null,\n        tabs: null,\n        tabPanes: null,\n        originalImage: null,\n        grayscaleImage: null,\n        binaryImage: null,\n        compOriginal: null,\n        compGrayscale: null,\n        compBinary: null,\n        imageName: null,\n        imageTag: null,\n        imageMethod: null,\n        imageCluster: null\n    },\n\n    // Inicializar el módulo\n    init() {\n        this.bindElements();\n        this.attachEvents();\n    },\n\n    // Vincular elementos DOM\n    bindElements() {\n        this.elements = {\n            modal: document.getElementById('comparison-modal'),\n            modalClose: document.getElementById('comparison-modal-close'),\n            title: document.getElementById('comparison-title'),\n            tabs: document.querySelectorAll('.tab-btn'),\n            tabPanes: document.querySelectorAll('.tab-pane'),\n            originalImage: document.getElementById('original-image'),\n            grayscaleImage: document.getElementById('grayscale-image'),\n            binaryImage: document.getElementById('binary-image'),\n            compOriginal: document.getElementById('comp-original'),\n            compGrayscale: document.getElementById('comp-grayscale'),\n            compBinary: document.getElementById('comp-binary'),\n            imageName: document.getElementById('image-name'),\n            imageTag: document.getElementById('image-tag'),\n            imageMethod: document.getElementById('image-method'),\n            imageCluster: document.getElementById('image-cluster')\n        };\n    },\n\n    // Adjuntar eventos\n    attachEvents() {\n        // Cerrar modal\n        this.elements.modalClose.addEventListener('click', () => {\n            this.closeModal();\n        });\n\n        // Click fuera del modal\n        this.elements.modal.addEventListener('click', (e) => {\n            if (e.target === this.elements.modal) {\n                this.closeModal();\n            }\n        });\n\n        // Navegación entre tabs\n        this.elements.tabs.forEach(tab => {\n            tab.addEventListener('click', (e) => {\n                e.preventDefault();\n                this.switchTab(tab.dataset.tab);\n            });\n        });\n\n        // ESC key para cerrar modal\n        document.addEventListener('keydown', (e) => {\n            if (e.key === 'Escape' && this.state.isOpen) {\n                this.closeModal();\n            }\n        });\n\n        // Teclas de navegación\n        document.addEventListener('keydown', (e) => {\n            if (!this.state.isOpen) return;\n            \n            const tabs = ['original', 'grayscale', 'binary', 'comparison'];\n            const currentIndex = tabs.indexOf(this.state.activeTab);\n            \n            if (e.key === 'ArrowLeft' && currentIndex > 0) {\n                e.preventDefault();\n                this.switchTab(tabs[currentIndex - 1]);\n            } else if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {\n                e.preventDefault();\n                this.switchTab(tabs[currentIndex + 1]);\n            }\n        });\n    },\n\n    // Abrir modal de comparación\n    openComparisonModal(image) {\n        this.state.currentImage = image;\n        this.state.isOpen = true;\n        this.state.activeTab = 'original';\n        \n        this.loadImageData();\n        this.updateUI();\n        this.showModal();\n    },\n\n    // Mostrar modal\n    showModal() {\n        this.elements.modal.style.display = 'flex';\n        document.body.style.overflow = 'hidden';\n        \n        setTimeout(() => {\n            this.elements.modal.classList.add('show');\n        }, 10);\n    },\n\n    // Cerrar modal\n    closeModal() {\n        this.elements.modal.classList.remove('show');\n        document.body.style.overflow = '';\n        \n        setTimeout(() => {\n            this.elements.modal.style.display = 'none';\n            this.state.isOpen = false;\n            this.state.currentImage = null;\n        }, 300);\n    },\n\n    // Cargar datos de imagen\n    loadImageData() {\n        if (!this.state.currentImage) return;\n        \n        const image = this.state.currentImage;\n        \n        // Actualizar título\n        this.elements.title.textContent = `Análisis: ${image.name}`;\n        \n        // Cargar imágenes\n        this.loadImageWithFallback(this.elements.originalImage, image.originalUrl, 'Imagen original');\n        this.loadImageWithFallback(this.elements.grayscaleImage, image.grayscaleUrl, 'Imagen en escala de grises');\n        this.loadImageWithFallback(this.elements.binaryImage, image.binaryUrl, 'Imagen binaria');\n        \n        // Cargar imágenes de comparación\n        this.loadImageWithFallback(this.elements.compOriginal, image.originalUrl, 'Original');\n        this.loadImageWithFallback(this.elements.compGrayscale, image.grayscaleUrl, 'Escala de grises');\n        this.loadImageWithFallback(this.elements.compBinary, image.binaryUrl, 'Binaria');\n        \n        // Actualizar información\n        this.elements.imageName.textContent = image.name;\n        this.elements.imageTag.textContent = image.tag || 'Sin etiqueta';\n        this.elements.imageMethod.textContent = utils.capitalize(image.method);\n        this.elements.imageCluster.textContent = `Cluster ${image.cluster}`;\n    },\n\n    // Cargar imagen con fallback\n    loadImageWithFallback(imgElement, src, alt) {\n        imgElement.alt = alt;\n        \n        // Crear imagen temporal para verificar si se puede cargar\n        const tempImg = new Image();\n        \n        tempImg.onload = () => {\n            imgElement.src = src;\n            imgElement.style.opacity = '0';\n            imgElement.onload = () => {\n                imgElement.style.transition = 'opacity 0.3s ease';\n                imgElement.style.opacity = '1';\n            };\n        };\n        \n        tempImg.onerror = () => {\n            // Usar imagen placeholder si falla la carga\n            imgElement.src = this.createPlaceholderImage(alt);\n        };\n        \n        tempImg.src = src;\n    },\n\n    // Crear imagen placeholder\n    createPlaceholderImage(text) {\n        const canvas = document.createElement('canvas');\n        canvas.width = 400;\n        canvas.height = 300;\n        const ctx = canvas.getContext('2d');\n        \n        // Fondo gris\n        ctx.fillStyle = '#f0f0f0';\n        ctx.fillRect(0, 0, canvas.width, canvas.height);\n        \n        // Texto\n        ctx.fillStyle = '#999';\n        ctx.font = '16px Arial';\n        ctx.textAlign = 'center';\n        ctx.fillText('Imagen no disponible', canvas.width / 2, canvas.height / 2 - 10);\n        ctx.fillText(text, canvas.width / 2, canvas.height / 2 + 10);\n        \n        return canvas.toDataURL();\n    },\n\n    // Cambiar tab activa\n    switchTab(tabName) {\n        if (this.state.activeTab === tabName) return;\n        \n        this.state.activeTab = tabName;\n        this.updateUI();\n    },\n\n    // Actualizar UI del modal\n    updateUI() {\n        // Actualizar tabs activas\n        this.elements.tabs.forEach(tab => {\n            const isActive = tab.dataset.tab === this.state.activeTab;\n            tab.classList.toggle('active', isActive);\n        });\n        \n        // Actualizar paneles activos\n        this.elements.tabPanes.forEach(pane => {\n            const isActive = pane.id === `tab-${this.state.activeTab}`;\n            pane.classList.toggle('active', isActive);\n        });\n        \n        // Animación suave\n        this.elements.tabPanes.forEach(pane => {\n            if (pane.classList.contains('active')) {\n                pane.style.opacity = '0';\n                setTimeout(() => {\n                    pane.style.transition = 'opacity 0.3s ease';\n                    pane.style.opacity = '1';\n                }, 50);\n            }\n        });\n    },\n\n    // Navegar a imagen siguiente (si está disponible)\n    nextImage() {\n        if (window.galleryModule && window.galleryModule.state.filteredImages) {\n            const images = window.galleryModule.state.filteredImages;\n            const currentIndex = images.findIndex(img => img.id === this.state.currentImage.id);\n            \n            if (currentIndex !== -1 && currentIndex < images.length - 1) {\n                this.openComparisonModal(images[currentIndex + 1]);\n            }\n        }\n    },\n\n    // Navegar a imagen anterior (si está disponible)\n    previousImage() {\n        if (window.galleryModule && window.galleryModule.state.filteredImages) {\n            const images = window.galleryModule.state.filteredImages;\n            const currentIndex = images.findIndex(img => img.id === this.state.currentImage.id);\n            \n            if (currentIndex > 0) {\n                this.openComparisonModal(images[currentIndex - 1]);\n            }\n        }\n    },\n\n    // Descargar imagen actual\n    downloadCurrentImage() {\n        if (!this.state.currentImage) return;\n        \n        const image = this.state.currentImage;\n        let url;\n        let filename;\n        \n        switch (this.state.activeTab) {\n            case 'grayscale':\n                url = image.grayscaleUrl;\n                filename = `${image.name}_grayscale.jpg`;\n                break;\n            case 'binary':\n                url = image.binaryUrl;\n                filename = `${image.name}_binary.jpg`;\n                break;\n            default:\n                url = image.originalUrl;\n                filename = `${image.name}_original.jpg`;\n                break;\n        }\n        \n        // Crear enlace temporal para descarga\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = filename;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n    },\n\n    // Compartir imagen (copiar URL)\n    shareImage() {\n        if (!this.state.currentImage) return;\n        \n        const image = this.state.currentImage;\n        const url = window.location.href;\n        \n        if (navigator.share) {\n            // Usar Web Share API si está disponible\n            navigator.share({\n                title: `Análisis de imagen: ${image.name}`,\n                text: `Mira este análisis de imagen procesada con ${utils.capitalize(image.method)}`,\n                url: url\n            });\n        } else if (navigator.clipboard) {\n            // Copiar URL al portapapeles\n            navigator.clipboard.writeText(url).then(() => {\n                utils.showToast('URL copiada al portapapeles', 'success');\n            });\n        }\n    },\n\n    // Obtener información detallada de la imagen\n    getImageInfo() {\n        if (!this.state.currentImage) return null;\n        \n        const image = this.state.currentImage;\n        return {\n            name: image.name,\n            tag: image.tag,\n            method: image.method,\n            cluster: image.cluster,\n            size: image.size,\n            dimensions: image.dimensions,\n            uploadDate: image.uploadDate,\n            urls: {\n                original: image.originalUrl,\n                grayscale: image.grayscaleUrl,\n                binary: image.binaryUrl\n            }\n        };\n    }\n};\n\n// Inicializar cuando el DOM esté listo\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => modalModule.init());\n} else {\n    modalModule.init();\n}\n\n// Exportar módulo\nwindow.modalModule = modalModule;