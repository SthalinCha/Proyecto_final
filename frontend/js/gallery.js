// ===== GALLERY MODULE =====\nconst galleryModule = {\n    // Estados del módulo\n    state: {\n        images: [],\n        filteredImages: [],\n        currentView: 'grid',\n        filters: {\n            tag: '',\n            method: ''\n        },\n        isLoading: false\n    },\n\n    // Referencias DOM\n    elements: {\n        imagesGrid: null,\n        loadingState: null,\n        emptyState: null,\n        tagFilter: null,\n        methodFilter: null,\n        clearFilters: null,\n        gridView: null,\n        listView: null,\n        totalImages: null,\n        totalClusters: null,\n        totalTags: null\n    },\n\n    // Inicializar el módulo\n    init() {\n        this.bindElements();\n        this.attachEvents();\n        this.loadImages();\n    },\n\n    // Vincular elementos DOM\n    bindElements() {\n        this.elements = {\n            imagesGrid: document.getElementById('images-grid'),\n            loadingState: document.getElementById('loading-state'),\n            emptyState: document.getElementById('empty-state'),\n            tagFilter: document.getElementById('tag-filter'),\n            methodFilter: document.getElementById('method-filter'),\n            clearFilters: document.getElementById('clear-filters'),\n            gridView: document.getElementById('grid-view'),\n            listView: document.getElementById('list-view'),\n            totalImages: document.getElementById('total-images'),\n            totalClusters: document.getElementById('total-clusters'),\n            totalTags: document.getElementById('total-tags')\n        };\n    },\n\n    // Adjuntar eventos\n    attachEvents() {\n        // Filtros\n        this.elements.tagFilter.addEventListener('change', (e) => {\n            this.state.filters.tag = e.target.value;\n            this.applyFilters();\n        });\n\n        this.elements.methodFilter.addEventListener('change', (e) => {\n            this.state.filters.method = e.target.value;\n            this.applyFilters();\n        });\n\n        // Limpiar filtros\n        this.elements.clearFilters.addEventListener('click', () => {\n            this.clearFilters();\n        });\n\n        // Cambio de vista\n        this.elements.gridView.addEventListener('click', () => {\n            this.setView('grid');\n        });\n\n        this.elements.listView.addEventListener('click', () => {\n            this.setView('list');\n        });\n    },\n\n    // Cargar imágenes del backend\n    async loadImages() {\n        if (this.state.isLoading) return;\n        \n        this.state.isLoading = true;\n        this.showLoading();\n        \n        try {\n            // Usar el endpoint existente del backend\n            const response = await utils.request(`${API_BASE_URL}/../images`);\n            \n            if (response && typeof response === 'object') {\n                this.state.images = this.processImageData(response);\n            } else {\n                this.state.images = [];\n            }\n            \n            this.state.filteredImages = [...this.state.images];\n            this.updateStatistics();\n            this.updateFilters();\n            this.renderImages();\n            \n        } catch (error) {\n            console.error('Error loading images:', error);\n            this.state.images = [];\n            this.state.filteredImages = [];\n            this.renderImages();\n            \n            // Mostrar mensaje de error solo si no es un error de conexión esperado\n            if (!error.message.includes('Failed to fetch')) {\n                utils.showToast('Error al cargar las imágenes', 'error');\n            }\n        } finally {\n            this.state.isLoading = false;\n            this.hideLoading();\n        }\n    },\n\n    // Procesar datos de imagen del backend\n    processImageData(data) {\n        const images = [];\n        \n        // El backend devuelve un índice de archivos\n        Object.entries(data).forEach(([filename, metadata]) => {\n            // Generar URLs para las diferentes versiones\n            const baseUrl = `${IMAGE_BASE_URL}/image/${filename.replace(/\\.[^/.]+$/, '')}`;\n            \n            images.push({\n                id: utils.generateUUID(),\n                filename: filename,\n                name: filename.replace(/\\.[^/.]+$/, ''), // Sin extensión\n                originalUrl: `${IMAGE_BASE_URL}/image/${filename}`,\n                grayscaleUrl: `${baseUrl}_grayscale.jpg`,\n                binaryUrl: `${baseUrl}_binary.jpg`,\n                thumbnailUrl: `${IMAGE_BASE_URL}/image/${filename}`, // Por ahora usamos la original\n                tag: metadata.tag || 'Sin etiqueta',\n                method: metadata.method || 'moments',\n                cluster: metadata.cluster || 0,\n                size: metadata.size || 0,\n                dimensions: metadata.dimensions || { width: 0, height: 0 },\n                uploadDate: metadata.uploadDate || new Date().toISOString()\n            });\n        });\n        \n        return images;\n    },\n\n    // Mostrar estado de carga\n    showLoading() {\n        this.elements.loadingState.style.display = 'block';\n        this.elements.emptyState.style.display = 'none';\n        this.elements.imagesGrid.style.display = 'none';\n    },\n\n    // Ocultar estado de carga\n    hideLoading() {\n        this.elements.loadingState.style.display = 'none';\n    },\n\n    // Renderizar imágenes\n    renderImages() {\n        const imagesToShow = this.state.filteredImages;\n        \n        if (imagesToShow.length === 0) {\n            this.elements.emptyState.style.display = 'block';\n            this.elements.imagesGrid.style.display = 'none';\n            return;\n        }\n        \n        this.elements.emptyState.style.display = 'none';\n        this.elements.imagesGrid.style.display = 'grid';\n        this.elements.imagesGrid.innerHTML = '';\n        \n        imagesToShow.forEach(image => {\n            const imageCard = this.createImageCard(image);\n            this.elements.imagesGrid.appendChild(imageCard);\n        });\n    },\n\n    // Crear tarjeta de imagen\n    createImageCard(image) {\n        const card = document.createElement('div');\n        card.className = 'image-card fade-in-up';\n        card.onclick = () => this.openImageModal(image);\n        \n        card.innerHTML = `\n            <img src=\"${image.thumbnailUrl}\" alt=\"${image.name}\" class=\"image-thumbnail\" \n                 onerror=\"this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlbiBubyBkaXNwb25pYmxlPC90ZXh0Pjwvc3ZnPg=='\">\n            <div class=\"image-info\">\n                <h3 class=\"image-title\">${utils.truncate(image.name, 25)}</h3>\n                <div class=\"image-meta\">\n                    <span class=\"image-tag\">${image.tag}</span>\n                    <span class=\"image-method\">${utils.capitalize(image.method)}</span>\n                </div>\n                <p class=\"image-cluster\">Cluster: ${image.cluster}</p>\n            </div>\n        `;\n        \n        return card;\n    },\n\n    // Abrir modal de imagen (delegado al módulo modal)\n    openImageModal(image) {\n        if (window.modalModule) {\n            window.modalModule.openComparisonModal(image);\n        }\n    },\n\n    // Aplicar filtros\n    applyFilters() {\n        this.state.filteredImages = this.state.images.filter(image => {\n            const tagMatch = !this.state.filters.tag || image.tag === this.state.filters.tag;\n            const methodMatch = !this.state.filters.method || image.method === this.state.filters.method;\n            \n            return tagMatch && methodMatch;\n        });\n        \n        this.renderImages();\n        this.updateStatistics();\n    },\n\n    // Limpiar filtros\n    clearFilters() {\n        this.state.filters = {\n            tag: '',\n            method: ''\n        };\n        \n        this.elements.tagFilter.value = '';\n        this.elements.methodFilter.value = '';\n        \n        this.applyFilters();\n    },\n\n    // Actualizar opciones de filtros\n    updateFilters() {\n        // Obtener etiquetas únicas\n        const uniqueTags = [...new Set(this.state.images.map(img => img.tag))]\n            .filter(tag => tag && tag !== 'Sin etiqueta')\n            .sort();\n        \n        // Limpiar opciones existentes (excepto la primera)\n        this.elements.tagFilter.innerHTML = '<option value=\"\">Todas las etiquetas</option>';\n        \n        // Agregar nuevas opciones\n        uniqueTags.forEach(tag => {\n            const option = document.createElement('option');\n            option.value = tag;\n            option.textContent = tag;\n            this.elements.tagFilter.appendChild(option);\n        });\n    },\n\n    // Establecer vista (grid/list)\n    setView(viewType) {\n        this.state.currentView = viewType;\n        \n        // Actualizar botones activos\n        this.elements.gridView.classList.toggle('active', viewType === 'grid');\n        this.elements.listView.classList.toggle('active', viewType === 'list');\n        \n        // Cambiar clase del grid\n        if (viewType === 'list') {\n            this.elements.imagesGrid.classList.add('list-view');\n            this.elements.imagesGrid.style.gridTemplateColumns = '1fr';\n        } else {\n            this.elements.imagesGrid.classList.remove('list-view');\n            this.elements.imagesGrid.style.gridTemplateColumns = '';\n        }\n    },\n\n    // Actualizar estadísticas\n    updateStatistics() {\n        const totalImages = this.state.filteredImages.length;\n        const uniqueClusters = new Set(this.state.filteredImages.map(img => img.cluster)).size;\n        const uniqueTags = new Set(this.state.filteredImages.map(img => img.tag)).size;\n        \n        // Animar números\n        this.animateNumber(this.elements.totalImages, totalImages);\n        this.animateNumber(this.elements.totalClusters, uniqueClusters);\n        this.animateNumber(this.elements.totalTags, uniqueTags);\n    },\n\n    // Animar cambio de números en estadísticas\n    animateNumber(element, targetValue) {\n        const startValue = parseInt(element.textContent) || 0;\n        const duration = 500; // ms\n        const startTime = performance.now();\n        \n        const animate = (currentTime) => {\n            const elapsed = currentTime - startTime;\n            const progress = Math.min(elapsed / duration, 1);\n            \n            const currentValue = Math.round(startValue + (targetValue - startValue) * progress);\n            element.textContent = currentValue;\n            \n            if (progress < 1) {\n                requestAnimationFrame(animate);\n            }\n        };\n        \n        requestAnimationFrame(animate);\n    },\n\n    // Refrescar galería\n    refresh() {\n        this.loadImages();\n    }\n};\n\n// Inicializar cuando el DOM esté listo\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => galleryModule.init());\n} else {\n    galleryModule.init();\n}\n\n// Exportar módulo\nwindow.galleryModule = galleryModule;